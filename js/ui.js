import { parseGZ, hourToBranch, hourPillar, tenGod, nayin, computeFiveElementStrength, buildStory, classifyShenSha, nayinEl } from './logic.js';
const $=(id)=>document.getElementById(id);
function colorEl(el){ return `el-${el}`; }
function elTagHTML(el,value,status){ return `<span class="el-tag ${colorEl(el)} ${status==="旺"?"hl-strong":""}">${el} ${value.toFixed(1)} ${status}</span>`; }
async function pasteGZ(){ try{ const t=await navigator.clipboard.readText(); const arr=t.replace(/\s+/g,"").match(/[甲乙丙丁戊己庚辛壬癸][子丑寅卯辰巳午未申酉戌亥]/g); if(!arr||arr.length<3){ alert("未偵測到三組干支"); return; } $("gzY").value=arr[0]; $("gzM").value=arr[1]; $("gzD").value=arr[2]; }catch(e){ alert("無法讀取剪貼簿"); }}
function guessHB(){ const t=$("birthTime").value; if(!t){ alert("請先輸入出生時間"); return; } const h=parseInt(t.split(":")[0],10); $("hourBranch").value=hourToBranch(h); $("hourBranch").classList.add("hl-strong"); setTimeout(()=>$("hourBranch").classList.remove("hl-strong"),1000); }
function renderFiveEl(fe){ const container=$("fiveElTags"); container.innerHTML=Object.keys(fe.weight).map(el=>elTagHTML(el,fe.weight[el],fe.status[el])).join(""); const dominance=Object.entries(fe.status).filter(([el,s])=>s==="旺").map(([el])=>el); const weak=Object.entries(fe.status).filter(([el,s])=>s==="弱").map(([el])=>el); let comment=""; if(dominance.length){ comment+=`偏旺：${dominance.join("、")}；`; } if(weak.length){ comment+=`偏弱：${weak.join("、")}；`; } if(!comment) comment="整體較均衡。"; $("fiveElComment").textContent=comment+`（總權重 ${fe.total.toFixed(1)}，平均 ${fe.avg.toFixed(2)}）`; }
function calc(){ const Y=parseGZ($("gzY").value), M=parseGZ($("gzM").value), D=parseGZ($("gzD").value); const hb=$("hourBranch").value.trim(); const name=$("name").value.trim()||"該命主"; if(!Y||!M||!D||!hb){ alert("請填妥年/月/日干支與時支"); return; } const ziCut=$("ziCut").value; const time=$("birthTime").value; let ziNote=""; if(time){ const hour=parseInt(time.split(":")[0],10); const inZi=(hour>=23||hour<1); if(inZi) ziNote= ziCut==="23cut"?"（夜子換日：請核對日柱是否+1）":"（子初不換日）"; } const HP=hourPillar(D[0],hb); if(!HP){ alert("時柱計算失敗"); return; } const TG={Y:tenGod(D[0],Y[0]), M:tenGod(D[0],M[0]), H:tenGod(D[0],HP[0])}; const NY={Y:nayin(Y), M:nayin(M), D:nayin(D), H:nayin(HP)}; const pillars={Y:[Y[0],Y[1]], M:[M[0],M[1]], D:[D[0],D[1]], H:[HP[0],HP[1]]}; const SS=classifyShenSha(pillars); const fe=computeFiveElementStrength({Y,M,D,H:HP}, NY); const catsOrder=["貴人","吉星","桃花","動星","陰煞","刑煞"]; function catHtml(){ return catsOrder.map(cat=>{ const arr=SS.cats[cat]||[]; if(!arr.length) return ""; return `<div><span class="cat-label cat-${cat}">${cat}</span> ${arr.map(x=>x.name+"["+x.sources.join("/")+']').join("、")}</div>`; }).join("")||"—"; }
  const tbody=$("tbody"); tbody.innerHTML=""; const rows=[["年","家族兵團",Y,TG.Y,NY.Y],["月","成長兵團",M,TG.M,NY.M],["日","本我兵團",D,"（日主）",NY.D],["時","未來兵團",HP,TG.H,NY.H]]; for(const [who,army,pillar,tg,ny] of rows){ const tr=document.createElement("tr"); const td1=document.createElement("td"); td1.textContent=army; tr.appendChild(td1); const elStatus=fe.status[nayinEl(ny)]||"平"; const related=SS.list.filter(s=>s.sources.some(src=>src.includes(army[0]))); const relatedCats={}; for(const r of related){ if(!relatedCats[r.cat]) relatedCats[r.cat]=[]; relatedCats[r.cat].push(r);} const story=buildStory(who,pillar,tg==="（日主）"?"":tg,relatedCats,ny,name,elStatus); const td2=document.createElement("td"); td2.innerHTML=`<div><span class="badge">四柱</span> ${pillar}</div><div class="section-title">十神</div><div>${tg||"—"}</div><div class="section-title">納音</div><div class="el-tag ${'el-'+nayinEl(ny)}">${ny}</div><div class="section-title">故事敘事</div><div class="story">${story}</div><div class="section-title">（本軍團命中神煞摘要）</div><div>${related.length? Object.entries(relatedCats).map(([c,v])=>`<span class="cat-label cat-${c}">${c}</span> ${v.map(x=>x.name).join("、")}`).join("<br>"):"—"}</div>`; tr.appendChild(td2); tbody.appendChild(tr);} $("report").style.display=""; $("fiveElPanel").style.display=""; renderFiveEl(fe); $("debug").innerHTML=`<div><b>子時設定：</b>${ziCut==="23cut"?"夜子換日 (23:00)":"子初不換日 (00:00)"} ${ziNote}</div><div>四柱：年 ${Y}｜月 ${M}｜日 ${D}｜時 ${HP}</div><div>十神：年 ${TG.Y||"—"}｜月 ${TG.M||"—"}｜時 ${TG.H||"—"}（日主 ${D[0]}）</div><div>納音：年 ${NY.Y}｜月 ${NY.M}｜日 ${NY.D}｜時 ${NY.H}</div><div>神煞分類：</div><div style="margin-left:6px">${catHtml()}</div><div class="note">神煞為教學精簡：未含全部 & 未考慮透幹 / 大運 / 流年。</div>`; window.__cache={name,Y,M,D,HP,TG,NY,SS,fe}; document.getElementById("report").scrollIntoView({behavior:"smooth",block:"start"}); }
function exportPdf(){ const c=window.__cache; if(!c){ alert("請先計算"); return; } const { jsPDF }=window.jspdf; const doc=new jsPDF({unit:"pt",format:"a4"}); const pad=48; let y=pad; const now=new Date(); const ts=now.toISOString().replace('T',' ').substring(0,19); doc.setFontSize(16); doc.text(`${c.name}｜八字人生兵法報告 v1.6`,pad,y); y+=22; doc.setFontSize(10); doc.text(`生成時間：${ts} (UTC)`,pad,y); y+=14; doc.text(`四柱：年 ${c.Y}｜月 ${c.M}｜日 ${c.D}｜時 ${c.HP}`,pad,y); y+=14; doc.text(`十神：年 ${c.TG.Y||"—"}｜月 ${c.TG.M||"—"}｜時 ${c.TG.H||"—"}（日主 ${c.D[0]}）`,pad,y); y+=14; doc.text(`納音：年 ${c.NY.Y}｜月 ${c.NY.M}｜日 ${c.NY.D}｜時 ${c.NY.H}`,pad,y); y+=16; doc.setFontSize(12); doc.text("五行力量 (天干=1, 納音=0.5)：",pad,y); y+=16; doc.setFontSize(10); const feLines=Object.keys(c.fe.weight).map(el=>`${el} ${c.fe.weight[el].toFixed(1)} (${c.fe.status[el]})`).join("  "); doc.text(feLines,pad,y); y+=18; doc.setFontSize(12); doc.text("神煞分類：",pad,y); y+=16; doc.setFontSize(10); const catsOrder=["貴人","吉星","桃花","動星","陰煞","刑煞"]; for(const cat of catsOrder){ const arr=c.SS.cats[cat]||[]; if(!arr.length) continue; const line=`${cat}：`+arr.map(x=>`${x.name}[${x.sources.join("/")}]`).join("、"); const lines=doc.splitTextToSize(line,500); for(const ln of lines){ doc.text(ln,pad,y); y+=12; if(y>760){ doc.addPage(); y=pad; } } } y+=10; const armies=[["年","家族兵團",c.Y,c.TG.Y,c.NY.Y],["月","成長兵團",c.M,c.TG.M,c.NY.M],["日","本我兵團",c.D,"（日主）",c.NY.D],["時","未來兵團",c.HP,c.TG.H,c.NY.H]]; doc.setFontSize(12); doc.text("軍團敘事：",pad,y); y+=18; doc.setFontSize(10); for(const [who,army,pillar,tg,ny] of armies){ const elStatus=c.fe.status[nayinEl(ny)]||"平"; const related=c.SS.list.filter(s=>s.sources.some(src=>src.includes(army[0]))); const relatedCats={}; for(const r of related){ if(!relatedCats[r.cat]) relatedCats[r.cat]=[]; relatedCats[r.cat].push(r);} const story=buildStory(who,pillar,tg==="（日主）"?"":tg,relatedCats,ny,c.name,elStatus); doc.text(`${army}｜${pillar}｜${ny}${tg&&tg!=="（日主）"?"｜十神:"+tg:""}`,pad,y); y+=12; const lines=doc.splitTextToSize(story,480); for(const ln of lines){ doc.text(ln,pad,y); y+=12; if(y>760){ doc.addPage(); y=pad; } } y+=6; if(y>760){ doc.addPage(); y=pad; } } if(y>720){ doc.addPage(); y=pad; } doc.setFontSize(9); const disclaimer="註：神煞採教學精簡規則；未含透干、藏干權重、節氣換日與大運流年推演，僅供結構示意。"; const dlines=doc.splitTextToSize(disclaimer,500); for(const ln of dlines){ doc.text(ln,pad,y); y+=11; } doc.save("bazi_report_v1_6.pdf"); }
function calcAndRender(){ try{ calc(); }catch(e){ console.error(e); alert("計算時出現例外，請檢查輸入。"); } }
document.addEventListener("DOMContentLoaded",()=>{ $("btnOpenCal").addEventListener("click",()=>window.open("https://fate.windada.com/cgi-bin/calendar","_blank")); $("btnGuessHB").addEventListener("click",guessHB); $("btnPaste").addEventListener("click",pasteGZ); $("btnCalc").addEventListener("click",calcAndRender); $("btnPdf").addEventListener("click",exportPdf); });